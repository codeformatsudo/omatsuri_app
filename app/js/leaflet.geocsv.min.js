L.GeoCSV=L.GeoJSON.extend({options:{titles:["lat","lng","popup"],latitudeTitle:"lat",longitudeTitle:"lng",fieldSeparator:";",lineSeparator:"\n",deleteDoubleQuotes:!0,firstLineTitles:!1},_propertiesNames:[],initialize:function(t,o){this._propertiesNames=[],L.Util.setOptions(this,o),L.GeoJSON.prototype.initialize.call(this,t,o)},addData:function(t){if("string"==typeof t){var o=this.options.titles;if(this.options.firstLineTitles){if(t=t.split(this.options.lineSeparator),t.length<2)return;o=t[0],t.splice(0,1),t=t.join(this.options.lineSeparator),o=o.trim().split(this.options.fieldSeparator);for(var e=0;e<o.length;e++)o[e]=this._deleteDoubleQuotes(o[e]);this.options.titles=o}for(var e=0;e<o.length;e++){var a=o[e].toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"_");(""==a||"_"==a)&&(a="prop-"+e),this._propertiesNames[e]=a}t=this._csv2json(t)}return L.GeoJSON.prototype.addData.call(this,t)},getPropertyName:function(t){var o=this.options.titles.indexOf(t),e="";return o>=0&&(e=this._propertiesNames[o]),e},getPropertyTitle:function(t){var o=this._propertiesNames.indexOf(t),e="";return o>=0&&(e=this.options.titles[o]),e},_deleteDoubleQuotes:function(t){return this.options.deleteDoubleQuotes&&(t=t.trim().replace(/^"/,"").replace(/"$/,"")),t},_csv2json:function(t){var o={};o.type="FeatureCollection",o.features=[];var e=this.options.titles;t=t.split(this.options.lineSeparator);for(var a=0;a<t.length;a++){var r=t[a].trim().split(this.options.fieldSeparator),i=parseFloat(r[e.indexOf(this.options.longitudeTitle)]),n=parseFloat(r[e.indexOf(this.options.latitudeTitle)]);if(r.length==e.length&&180>i&&i>-180&&90>n&&n>-90){var s={};s.type="Feature",s.geometry={},s.properties={},s.geometry.type="Point",s.geometry.coordinates=[i,n];for(var p=0;p<e.length;p++)e[p]!=this.options.latitudeTitle&&e[p]!=this.options.longitudeTitle&&(s.properties[this._propertiesNames[p]]=this._deleteDoubleQuotes(r[p]));o.features.push(s)}}return o}}),L.geoCsv=function(t,o){return new L.GeoCSV(t,o)};